@model Pozoriste.Web.Models.PredstavaAdminVM
@{
    ViewData["Title"] = "Izmeni predstavu";
}

<h2 class="mb-3">Izmeni predstavu</h2>

<form method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="PredstavaId" />

    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <div class="mb-3">
        <label class="form-label">Naziv</label>
        <input class="form-control" asp-for="Naziv" />
        <span class="text-danger" asp-validation-for="Naziv"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Opis</label>
        <textarea class="form-control" asp-for="Opis" rows="4"></textarea>
        <span class="text-danger" asp-validation-for="Opis"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Slika</label>
        <input class="form-control" type="file" name="slika" accept="image/*" />
        <span class="text-danger" asp-validation-for="SlikaUrl"></span>
        <div class="form-text">Dozvoljeni formati: JPG, PNG, WEBP.</div>
        @if (!string.IsNullOrWhiteSpace(Model.SlikaUrl))
        {
            <div class="mt-2">
                <img src="@Model.SlikaUrl" alt="@Model.Naziv" class="predstava-img-preview" />
            </div>
        }
    </div>

    <div class="row g-3">
        <div class="col-md-4">
            <label class="form-label">Cena</label>
            <input class="form-control" asp-for="Cena" type="number" step="100" min="500" />
            <span class="text-danger" asp-validation-for="Cena"></span>
        </div>
        <div class="col-md-4">
            <label class="form-label">Trajanje (min)</label>
            <input class="form-control" asp-for="TrajanjeMin" type="number" min="1" />
            <span class="text-danger" asp-validation-for="TrajanjeMin"></span>
        </div>
        <div class="col-md-4">
            <label class="form-label">Zanr</label>
            <select class="form-select" asp-for="ZanrId" asp-items="ViewBag.Zanrovi">
                <option value="">-- izaberi zanr --</option>
            </select>
            <span class="text-danger" asp-validation-for="ZanrId"></span>
        </div>
    </div>

    <div class="mb-3 mt-3">
        <label class="form-label">Glumci</label>
        <div class="dropdown w-100" id="glumciDropdown">
            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start"
                    type="button"
                    data-bs-toggle="dropdown"
                    data-bs-auto-close="outside"
                    aria-expanded="false">
                <span class="glumci-label">Izaberi glumce</span>
            </button>
            <div class="dropdown-menu w-100 p-3" style="max-height: 260px; overflow: auto;">
                @if (Model.Glumci != null && Model.Glumci.Any())
                {
                    foreach (var g in Model.Glumci)
                    {
                        var id = $"glumac_{g.Value}";
                        <div class="form-check">
                            <input class="form-check-input glumci-check"
                                   type="checkbox"
                                   name="SelectedGlumciIds"
                                   value="@g.Value"
                                   id="@id"
                                   @(g.Selected ? "checked" : null) />
                            <label class="form-check-label" for="@id">@g.Text</label>
                        </div>
                    }
                }
                else
                {
                    <div class="text-muted">Nema glumaca.</div>
                }
            </div>
        </div>
        <div class="form-text">Izaberi jednog ili vise glumaca.</div>
    </div>

    <div class="mt-4">
        <button class="btn btn-primary" type="submit">Sacuvaj</button>
        <a class="btn btn-outline-secondary" asp-area="Admin" asp-controller="Predstava" asp-action="Index">Nazad</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            var root = document.getElementById("glumciDropdown");
            if (!root) return;
            var label = root.querySelector(".glumci-label");
            var checks = root.querySelectorAll(".glumci-check");
            function updateLabel() {
                var selected = [];
                checks.forEach(function (c) {
                    if (c.checked) {
                        var lbl = root.querySelector("label[for='" + c.id + "']");
                        if (lbl) selected.push(lbl.textContent.trim());
                    }
                });
                if (selected.length === 0) {
                    label.textContent = "Izaberi glumce";
                } else if (selected.length <= 3) {
                    label.textContent = selected.join(", ");
                } else {
                    label.textContent = selected.length + " izabrano";
                }
            }
            checks.forEach(function (c) { c.addEventListener("change", updateLabel); });
            updateLabel();
        })();
    </script>
}
