@model Pozoriste.Web.Models.RezervacijaSeatVM

@{
    ViewData["Title"] = "Izbor sedista";
    var vm = Model!;
    var selectedCount = vm.Selected.Count;
    var ukupno = vm.Cena * selectedCount;
    var zones = vm.Zone ?? new List<Pozoriste.Web.Models.SeatZoneVm>();
}

@functions {
    private static string RowLabel(int row)
    {
        if (row >= 1 && row <= 26)
            return ((char)('A' + row - 1)).ToString();

        return row.ToString();
    }

    private static Pozoriste.Web.Models.SeatZoneVm? ZoneForRow(int row, List<Pozoriste.Web.Models.SeatZoneVm> zones)
    {
        return zones.FirstOrDefault(z => row >= z.OdReda && row <= z.DoReda);
    }
}

<div class="flow-steps mb-3">
    <div class="flow-step is-done">
        <span>1</span>
        <div>Termin</div>
    </div>
    <div class="flow-step is-active">
        <span>2</span>
        <div>Sedista</div>
    </div>
    <div class="flow-step">
        <span>3</span>
        <div>Potvrda</div>
    </div>
</div>

<div class="row g-4">
    <div class="col-12 col-lg-8">
        <div class="card p-3 p-md-4 reservation-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <div class="text-muted text-uppercase small fw-semibold">Korak 2</div>
                    <h1 class="h4 mb-1">Izaberite sedista</h1>
                    <div class="text-muted small">@vm.Predstava - @vm.Sala</div>
                </div>
            </div>

            <form asp-action="Create" method="post">
                <input type="hidden" asp-for="TerminId" />
                <div asp-validation-summary="All" class="text-danger mb-2"></div>

                <div class="seat-screen">Scena</div>

                <div class="seat-grid">
                    @for (var row = 1; row <= vm.BrojRedova; row++)
                    {
                        var zone = ZoneForRow(row, zones);
                        var zoneClass = zone?.CssClass ?? "zone-standard";
                        var zoneLabel = zone?.Naziv ?? "Standard";

                        <div class="seat-row zone-row @zoneClass">
                            <div class="seat-label">
                                @RowLabel(row)
                                <span class="seat-zone-tag @zoneClass">@zoneLabel</span>
                            </div>
                            <div class="seat-items">
                                @for (var seat = 1; seat <= vm.SedistaPoRedu; seat++)
                                {
                                    var key = $"{row}-{seat}";
                                    var isTaken = vm.Zauzeta.Contains(key);
                                    var isSelected = vm.Selected.Contains(key);
                                    var multiplier = zone?.CenaMultiplier ?? 1.0m;

                                    <label class="seat">
                                        @if (isTaken)
                                        {
                                            <input type="checkbox"
                                                   class="seat-checkbox"
                                                   data-seat-label="@($"{RowLabel(row)}{seat}")"
                                                   data-multiplier="@multiplier.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)"
                                                   data-zone="@zoneLabel"
                                                   name="Selected"
                                                   value="@key"
                                                   disabled />
                                        }
                                        else if (isSelected)
                                        {
                                            <input type="checkbox"
                                                   class="seat-checkbox"
                                                   data-seat-label="@($"{RowLabel(row)}{seat}")"
                                                   data-multiplier="@multiplier.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)"
                                                   data-zone="@zoneLabel"
                                                   name="Selected"
                                                   value="@key"
                                                   checked />
                                        }
                                        else
                                        {
                                            <input type="checkbox"
                                                   class="seat-checkbox"
                                                   data-seat-label="@($"{RowLabel(row)}{seat}")"
                                                   data-multiplier="@multiplier.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)"
                                                   data-zone="@zoneLabel"
                                                   name="Selected"
                                                   value="@key" />
                                        }
                                        <span>@seat</span>
                                    </label>
                                }
                            </div>
                        </div>
                    }
                </div>

                <div class="seat-legend mt-3">
                    <div><span class="seat-swatch seat-available"></span> Slobodno</div>
                    <div><span class="seat-swatch seat-selected"></span> Izabrano</div>
                    <div><span class="seat-swatch seat-taken"></span> Zauzeto</div>
                    @foreach (var z in zones)
                    {
                        <div><span class="seat-swatch @z.CssClass"></span> @z.Naziv (@RowLabel(z.OdReda)-@RowLabel(z.DoReda))</div>
                    }
                </div>

                <div class="d-flex flex-wrap gap-2 mt-4">
                    <button type="submit" class="btn btn-primary">Potvrdi rezervaciju</button>
                    <a class="btn btn-outline-secondary" asp-controller="Home" asp-action="Index">Nazad</a>
                </div>
            </form>
        </div>
    </div>

    <div class="col-12 col-lg-4">
        <div class="card p-3 p-md-4 reservation-summary"
             data-seat-summary
             data-price="@vm.Cena.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)">
            <h2 class="h6 text-uppercase text-muted">Rezime rezervacije</h2>
            <div class="mt-2">
                <div class="fw-semibold">@vm.Predstava</div>
                <div class="text-muted">@vm.Sala</div>
            </div>

            <div class="summary-list mt-3">
                <div class="summary-row">
                    <span class="text-muted">Datum</span>
                    <span>@vm.DatumVreme.ToString("dd.MM.yyyy")</span>
                </div>
                <div class="summary-row">
                    <span class="text-muted">Vreme</span>
                    <span>@vm.DatumVreme.ToString("HH:mm")</span>
                </div>
                <div class="summary-row">
                    <span class="text-muted">Cena</span>
                    <span>@vm.Cena.ToString("0.00") RSD</span>
                </div>
                @foreach (var z in zones)
                {
                    var zonaCena = (vm.Cena * z.CenaMultiplier).ToString("0.00");
                    <div class="summary-row">
                        <span class="text-muted">@z.Naziv cena</span>
                        <span>@zonaCena RSD</span>
                    </div>
                }
                <div class="summary-row">
                    <span class="text-muted">Izabrano</span>
                    <span data-seat-count>@selectedCount</span>
                </div>
                @foreach (var z in zones)
                {
                    <div class="summary-row">
                        <span class="text-muted">@z.Naziv</span>
                        <span data-zone-count="@z.Naziv">0</span>
                    </div>
                }
                <div class="summary-row summary-total">
                    <span>Ukupno</span>
                    <span data-seat-total>@ukupno.ToString("0.00") RSD</span>
                </div>
            </div>

            <div class="mt-3">
                <div class="text-muted small fw-semibold mb-2">Izabrana sedista</div>
                <div class="seat-list" data-seat-list></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}
